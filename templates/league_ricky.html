<!DOCTYPE html>
<html lang="en">
<head>
    {% include '_google_analytics.html' %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Pickleball League App{% if league.name %} - {{ league.name }}{% endif %}</title>
    <style>
        {% include '_main.css' %}

        h1 {
            width: 80%; /* to avoid getting behind the menu */
        }
        
        .contributor-container, .link-container {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            width: 99%; 
            overflow-x: auto;
            font-size: 0.75rem;
            font-style: italic;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            position: relative;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .contributor-container::before, .link-container::before {
            content: "";
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .contributor-show-container, .link-show-container {
            margin-left: 1.5rem;
            white-space: nowrap;
            text-align: left;
        }

        .name-show-container {
            display: block;
            align-items: center;
        }

        .round-show-container {
            display: block;
        }

        #edit-save-players, #edit-cancel-players {
            visibility: hidden;
        }

        .link-edit-container {
            margin-left: 1.5rem;
            display: none;
            white-space: nowrap;
        }

        .name-edit-container {
            display: none;
            align-items: center;
        }

        .round-edit-container {
            display: none;
        }

        .contributor-edit-container {
            display: none;
            white-space: nowrap;
            align-items: center;
        }

        .link-input {
            width: 150px;
            padding: 0.375rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .contributor-input {
            width: 150px;
            padding: 0.375rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .team-input {
            width: 50px;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .players-out-input {
            width: 200px;
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .name-input {
            width: 400px;
            font-size: 2rem;
            font-weight: 700;
            padding: 0.375rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }
        
        .league-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin: 0.5rem 0;
            position: relative;
        }
        
        .league-table th, .league-table td {
            padding: 0.4rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .league-table th {
            background-color: var(--primary-color);
            color: var(--card-bg);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .league-table tr:nth-child(even) {
            background-color: rgba(241, 245, 249, 0.75);
        }
        
        .league-table tr:hover {
            background-color: rgba(241, 245, 249, 1);
        }
        
        .round-cell {
            text-align: left;
            background-color: rgba(30, 64, 175, 0.08);
            border-right: 1px solid var(--border-color) !important;
            padding: 0.5rem;
            line-height: 1.4;
            white-space: nowrap;
        }
        
        .round-number {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
        }
        
        .match {
            margin-bottom: 0.125rem;
        }
        
        .team {
            display: inline-block;
            background-color: var(--card-bg);
            padding: 0.125rem 0.375rem;
            border-radius: 0.125rem;
            margin: 0.125rem;
            border: 1px solid var(--border-color);
            font-size: 0.75rem;
        }
        
        .vs {
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.75rem;
        }
        
        .players-out {
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .players-out-label {
            font-weight: 600;
        }
        
        .footer {
            margin-top: 1rem;
            text-align: center;
            display: flex;
            justify-content:center;
            align-items: center;
            gap: 1rem;
        }
        
        @media print {
            body {
                background-color: var(--card-bg);
                padding: 0;
            }

            .contributor-container, .link-container {
                width: 98%;
            }
            
            .league-table {
                box-shadow: none;
                border: 1px solid var(--border-color);
            }
            
            .league-table th, .league-table td {
                border: 1px solid var(--border-color);
            }
            
            .footer {
                display: none;
            }
            
            .league-table th {
                background-color: rgba(30, 64, 175, 0.1) !important;
                color: var(--text-color) !important;
                border: 1px solid var(--border-color) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .round-cell {
                background-color: rgba(30, 64, 175, 0.08) !important;
                border-right: 1px solid var(--border-color) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .team {
                border: 1px solid var(--border-color);
            }
        }

        @media (max-width: 768px) {
            .contributor-container, .link-container {
                font-size: 10px;
                width: 96%;
            }
        }
    
        {% if league.scoring_system.value != 'none' %}
            {% include '_ranking.css' %}
        {% endif %}

        {% include '_auth.css' %}

        /* Add these new styles */
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--card-bg);
            z-index: 1000;
            overflow: auto;
            padding: 1rem;
        }

        .fullscreen-mode .league-table {
            font-size: 1.2em;
        }

        .fullscreen-mode .round-cell {
            font-size: 1.1em;
        }

        .fullscreen-mode .team {
            font-size: 1em;
        }

        .exit-fullscreen {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
        }

        .exit-fullscreen:hover {
            opacity: 0.9;
        }
    </style>
    <script>
        function printPage() {
            // Force landscape printing
            var style = document.createElement('style');
            style.type = 'text/css';
            style.media = 'print';
            style.innerHTML = '@page { size: landscape; }';
            document.head.appendChild(style);

            window.print();
        }
        
        // Store teammate relationships for each player in each round
        const teammateMap = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            initTeammateMap();
            addScoreEventListeners();
            updateLastUpdatedTime();
        });
        
        var initTeammateMap = function() {
            // Create a mapping of player names to their indices
            const playerIndices = {};
            {% for player in league.players %}
                playerIndices["{{ player }}"] = {{ loop.index }};
            {% endfor %}
            
            // Create a mapping of teammates for each round
            {% for round in league.schedule %}
                teammateMap["{{ round.number }}"] = {};
                {% for match in round.matches %}
                    // Team 1
                    teammateMap["{{ round.number }}"]["{{ match.players[0].name }}"] = {
                        teammate: "{{ match.players[1].name }}",
                        teammateIndex: playerIndices["{{ match.players[1].name }}"]
                    };
                    teammateMap["{{ round.number }}"]["{{ match.players[1].name }}"] = {
                        teammate: "{{ match.players[0].name }}",
                        teammateIndex: playerIndices["{{ match.players[0].name }}"]
                    };
                    
                    // Team 2
                    teammateMap["{{ round.number }}"]["{{ match.players[2].name }}"] = {
                        teammate: "{{ match.players[3].name }}",
                        teammateIndex: playerIndices["{{ match.players[3].name }}"]
                    };
                    teammateMap["{{ round.number }}"]["{{ match.players[3].name }}"] = {
                        teammate: "{{ match.players[2].name }}",
                        teammateIndex: playerIndices["{{ match.players[2].name }}"]
                    };
                {% endfor %}
            {% endfor %}
        }
        
        var addScoreEventListeners = function() {
            // Add event listeners to all score inputs and selects
            {% for round in league.schedule %}
                {% for player in league.players %}
                    {% if player.name not in round.players_out|map(attribute='name')|list %}
                        const inputId{{ round.number }}_{{ loop.index }} = "player_score_round{{ round.number }}_player{{ loop.index }}";
                        const inputElement{{ round.number }}_{{ loop.index }} = document.getElementById(inputId{{ round.number }}_{{ loop.index }});
                        if (inputElement{{ round.number }}_{{ loop.index }}) {
                            // For number inputs (score system)
                            if (inputElement{{ round.number }}_{{ loop.index }}.type === 'number') {
                                inputElement{{ round.number }}_{{ loop.index }}.addEventListener('input', function() {
                                    syncTeammateScore("{{ round.number }}", "{{ player }}", this.value);
                                });
                            }
                            // For select elements (w/l system)
                            else if (inputElement{{ round.number }}_{{ loop.index }}.tagName === 'SELECT') {
                                inputElement{{ round.number }}_{{ loop.index }}.addEventListener('change', function() {
                                    syncTeammateScore("{{ round.number }}", "{{ player }}", this.value);
                                });
                            }
                        }
                    {% endif %}
                {% endfor %}
            {% endfor %}
        }

        var updateLastUpdatedTime = function() {
            var lastUpdatedTime = document.getElementById("last-updated-time");
            var secondsSinceLastUpdate = {{ league.get_seconds_since_version_update() }};
            if (Math.floor(secondsSinceLastUpdate / 172800) > 0) {
                lastUpdatedTime.innerHTML = Math.floor(secondsSinceLastUpdate / 172800) + " days ago";
            } else if (Math.floor(secondsSinceLastUpdate / 3600) > 0) {
                lastUpdatedTime.innerHTML = Math.floor(secondsSinceLastUpdate / 3600) + "+ hours ago";
            } else {
                var timer = setInterval(function() {
                    secondsSinceLastUpdate++;
                    if (secondsSinceLastUpdate < 15) {
                        lastUpdatedTime.innerHTML = "just now";
                    } else {
                        var minutes = Math.floor((secondsSinceLastUpdate % 3600) / 60);
                        var seconds = secondsSinceLastUpdate % 60;
                        if (minutes > 0) {
                            lastUpdatedTime.innerHTML = minutes + ":" + (seconds < 10 ? "0" : "") + seconds + " minute" + (minutes > 1 ? "s" : "") + " ago";
                        } else {
                            lastUpdatedTime.innerHTML = seconds + " seconds ago";
                        }
                    }
                }, 1000);
            }
        }
        
        var syncTeammateScore = function(roundNumber, playerName, value) {
            // Check if this player has a teammate in this round
            if (teammateMap[roundNumber] && teammateMap[roundNumber][playerName]) {
                const teammateInfo = teammateMap[roundNumber][playerName];
                const teammateInputId = `player_score_round${roundNumber}_player${teammateInfo.teammateIndex}`;
                const teammateInput = document.getElementById(teammateInputId);
                
                if (teammateInput) {
                    // Update the teammate's input with the same value
                    teammateInput.value = value;
                    
                    // If it's a select element, need to trigger change event for any dependent logic
                    if (teammateInput.tagName === 'SELECT') {
                        const event = new Event('change', { bubbles: true });
                        teammateInput.dispatchEvent(event);
                    }
                }
            }
        }

        var copyLink = function(link) {
            navigator.clipboard.writeText(link);
            return false;
        }

        var editLink = function() {
            document.getElementsByClassName("link-show-container")[0].style.display = "none";
            document.getElementsByClassName("link-edit-container")[0].style.display = "block";
            document.getElementById("new_league_id").focus();
            return false;
        }

        var cancelEditLink = function() {
            document.getElementsByClassName("link-edit-container")[0].style.display = "none";
            document.getElementsByClassName("link-show-container")[0].style.display = "block";
            return false;
        }

        var saveLink = function() {
            if ((document.getElementById("new_league_id").value != document.getElementById("original_league_id").value) &&
                    (document.getElementById("new_league_id").value.length > 0))  
                {
                var new_league_id = document.getElementById("new_league_id").value;
                // Replace spaces and underscores with dashes
                new_league_id = new_league_id.replace(/[\s_]/g, '-');
                // Replace multiple dashes with a single dash
                new_league_id = new_league_id.replace(/-+/g, '-');
                // Replace dashes at the beginning and end with an empty string
                new_league_id = new_league_id.replace(/^-+|-+$/g, '');
                // Replace any non-alphanumeric characters (besides dashes) with an empty string
                new_league_id = new_league_id.replace(/[^a-zA-Z0-9-]/g, '');
                document.getElementById("new_league_id").value = new_league_id;
                document.getElementById("update_league_id").value = "1";
                document.getElementById("league_form").submit();
                return true;
            }
            document.getElementsByClassName("link-edit-container")[0].style.display = "none";
            document.getElementsByClassName("link-show-container")[0].style.display = "block";
            return false;
        }

        var editName = function() {
            document.getElementsByClassName("name-show-container")[0].style.display = "none";
            document.getElementsByClassName("name-edit-container")[0].style.display = "block";
            document.getElementById("new_league_name").focus();
            return false;
        }

        var cancelEditName = function() {
            document.getElementsByClassName("name-edit-container")[0].style.display = "none";
            document.getElementsByClassName("name-show-container")[0].style.display = "block";
            return false;
        }

        var saveName = function() {
            if ((document.getElementById("new_league_name").value != document.getElementById("original_league_name").value) &&
                    (document.getElementById("new_league_name").value.length > 0))  
                {
                var new_league_name = document.getElementById("new_league_name").value;
                document.getElementById("new_league_name").value = new_league_name;
                document.getElementById("update_league_name").value = "1";
                document.getElementById("league_form").submit();
                return true;
            }
            document.getElementsByClassName("name-edit-container")[0].style.display = "none";
            document.getElementsByClassName("name-show-container")[0].style.display = "block";
            return false;
        }

        var editPlayers = function() {
            document.getElementById("edit-players").style.visibility = "hidden";
            for (var i = 0; i < document.getElementsByClassName("round-show-container").length; i++) {
                document.getElementsByClassName("round-show-container")[i].style.display = "none";
                document.getElementsByClassName("round-edit-container")[i].style.display = "block";
            }
            document.getElementById("edit-save-players").style.visibility = "visible";
            document.getElementById("edit-cancel-players").style.visibility = "visible";
            return false;
        }

        var savePlayers = function() {
            // traverse all inputs to ensure they are valid player names
            var all_new_players = [];
            var all_original_players = [];
            for (var i = 1; i <= document.getElementsByClassName("round-show-container").length; i++) {
                var number_of_matches = document.getElementsByName("round-number"+i+"-matches")[0].value;
                for (var j = 1; j <= number_of_matches; j++) {
                    var player1 = document.getElementsByName("player-name-round"+i+"-match"+j+"-player1")[0].value;
                    var player2 = document.getElementsByName("player-name-round"+i+"-match"+j+"-player2")[0].value;
                    var player3 = document.getElementsByName("player-name-round"+i+"-match"+j+"-player3")[0].value;
                    var player4 = document.getElementsByName("player-name-round"+i+"-match"+j+"-player4")[0].value;
                    var original_player1 = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player1")[0].value;
                    var original_player2 = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player2")[0].value;
                    var original_player3 = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player3")[0].value;
                    var original_player4 = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player4")[0].value;
                    if ((player1 == "") || (player2 == "") ||  (player3 == "") || (player4 == "")) {
                        alert("Please fill in all player names for *round " + i + " match " + j + "*.");
                        return false;
                    }
                    var validPlayerNameRegex = /^[a-zA-Z0-9\s]*$/;
                    if (!validPlayerNameRegex.test(player1) || !validPlayerNameRegex.test(player2) || !validPlayerNameRegex.test(player3) || !validPlayerNameRegex.test(player4)) {
                        alert("Player names can only contain letters, numbers and spaces. Check your entries for *round " + i + " match " + j + "*.");
                        return false;
                    }
                    if (all_new_players.indexOf(player1) == -1) {  all_new_players.push(player1); }
                    if (all_new_players.indexOf(player2) == -1) { all_new_players.push(player2); }
                    if (all_new_players.indexOf(player3) == -1) { all_new_players.push(player3); }
                    if (all_new_players.indexOf(player4) == -1) { all_new_players.push(player4); }
                    if (all_original_players.indexOf(original_player1) == -1) { all_original_players.push(original_player1); }
                    if (all_original_players.indexOf(original_player2) == -1) { all_original_players.push(original_player2); }
                    if (all_original_players.indexOf(original_player3) == -1) { all_original_players.push(original_player3); }
                    if (all_original_players.indexOf(original_player4) == -1) { all_original_players.push(original_player4); }
                }
            }
            if (all_new_players.sort().join(",") != all_original_players.sort().join(",")) {
                var added_players = all_new_players.filter(player => all_original_players.indexOf(player) === -1);
                var removed_players = all_original_players.filter(player => all_new_players.indexOf(player) === -1);
                var message = "The changes look good but the number of players and/or the players have changed:\n";
                if (added_players.length > 0) {
                    message += "\n- Added players: " + added_players.join(", ");
                }
                if (removed_players.length > 0) {
                    message += "\n- Removed players: " + removed_players.join(", ");
                }
                message += "\n\nDo you want to proceed?";
                if (confirm(message) != true) {
                    cancelEditPlayers();
                    return false;
                }
            }
            document.getElementById("update_player_names").value = "1";
            document.getElementById("league_form").submit();
            return true;
        }

        var cancelEditPlayers = function() {            
            document.getElementById("edit-save-players").style.visibility = "hidden";
            document.getElementById("edit-cancel-players").style.visibility = "hidden";
            //reset all inputs to their original values
            for (var i = 1; i <= document.getElementsByClassName("round-show-container").length; i++) {
                var number_of_matches = document.getElementsByName("round-number"+i+"-matches")[0].value;
                for (var j = 1; j <= number_of_matches; j++) {
                    document.getElementsByName("player-name-round"+i+"-match"+j+"-player1")[0].value = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player1")[0].value;
                    document.getElementsByName("player-name-round"+i+"-match"+j+"-player2")[0].value = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player2")[0].value;
                    document.getElementsByName("player-name-round"+i+"-match"+j+"-player3")[0].value = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player3")[0].value;
                    document.getElementsByName("player-name-round"+i+"-match"+j+"-player4")[0].value = document.getElementsByName("original-player-name-round"+i+"-match"+j+"-player4")[0].value;
                    if (document.getElementsByName("players-out-round"+i)[0]) {
                        document.getElementsByName("players-out-round"+i)[0].value = document.getElementsByName("original-players-out-round"+i)[0].value;
                    }
                }
            }
            // reset the display of the round show and edit containers
            for (var i = 0; i < document.getElementsByClassName("round-show-container").length; i++) {
                document.getElementsByClassName("round-show-container")[i].style.display = "block";
                document.getElementsByClassName("round-edit-container")[i].style.display = "none";
            }
            document.getElementById("edit-players").style.visibility = "visible";
            return false;
        }

        var addContributor = function() {
            document.getElementsByClassName("contributor-edit-container")[0].style.display = "block";
            document.getElementById("add-contributor").style.display = "none";
            return false;
        }

        var saveContributor = function() {
            var new_contributor_email = document.getElementById("new_contributor_email").value;
            if (new_contributor_email == "") {
                alert("Please enter an email address for the new contributor.");
                return false;
            }
            var all_contributor_emails = document.getElementById("all_contributor_emails").value;
            if (all_contributor_emails.indexOf(new_contributor_email) != -1) {
                alert("\"" + new_contributor_email + "\" is already a contributor.");
                return false;
            }
            if (!isValidEmail(new_contributor_email)) {
                alert("Invalid email format.");
                return false;
            }
            document.getElementById("update_contributors").value = "1";
            document.getElementById("league_form").submit();
            return true;
        }

        var cancelAddContributor = function() {
            document.getElementsByClassName("contributor-edit-container")[0].style.display = "none";
            document.getElementById("add-contributor").style.display = "block";
            return false;
        }

        var isValidEmail = function(email) {
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        var textSize = 0.75;
        var textSizeIncrement = 0.25;
        
        var updateTextSize = function(className) {
            for (var i = 0; i < document.getElementsByClassName(className).length; i++) {
                document.getElementsByClassName(className)[i].style.fontSize = textSize + "rem";
            }
        }

        var updateAllTextSizes = function() {
            updateTextSize("team");
            updateTextSize("vs");
            updateTextSize("player-scores-header");
            updateTextSize("players-out");
            updateTextSize("team-input");
            updateTextSize("players-out-input");
            updateTextSize("player-score-select");
            updateTextSize("player-score-input");
            updateTextSize("player-score-label");
        }
        
        var increaseTextSize = function() {
            textSize = textSize + textSizeIncrement;
            updateAllTextSizes();
            return false;
        }

        var decreaseTextSize = function() {
            if (textSize > 0.75) {
                textSize = textSize - textSizeIncrement;
            }
            updateAllTextSizes();
            return false;
        }

        {% include '_auth.js' %}
    </script>
</head>
<body>
    {% include '_auth.html' %}
    <form id="league_form" name="league_form" action="/save_league" method="post">
    <input type="hidden" name="league_id" value="{{ league.id }}">
    <input type="hidden" name="version_control" value="{{ league.get_version() }}">
    <div class="container">
        <h1>
            {% if league.name %}
                <div class="name-show-container">{{ league.name }}
                {% if league.can_edit(user.email) %}
                    <button id="edit-name" class="small-button" onclick="return editName()">Edit&nbsp;name&nbsp;✎</button>
                {% endif %}
                </div>  
            {% else %}
                <div class="name-show-container">League created on {{ league.date_created }}
                {% if league.can_edit(user.email) %}
                    <button id="edit-name" class="small-button" onclick="return editName()">Edit&nbsp;name&nbsp;✎</button>
                {% endif %}
                </div>  
            {% endif %}
            <div class="name-edit-container">
                <input type="text" id="new_league_name" name="new_league_name" class="name-input" value="{{ league.name }}">
                <input type="hidden" id="original_league_name" name="original_league_name" value="{{ league.name }}">
                <input type="hidden" id="update_league_name" name="update_league_name" value="">
                <button class="small-button" onclick="return saveName()">Save&nbsp;💾</button>
                <button class="small-button" onclick="return cancelEditName()">Cancel&nbsp;❌</button>
            </div>
        </h1>
        <h3>League details</h3>
        <div class="contributor-container">
            <div class="contributor-show-container">
                <i><b>Last updated:</b>&nbsp;<span id="last-updated-time">...</span></i>
            </div>
        </div>
        {% if league.owner != None %}
        <div class="contributor-container">
            <div class="contributor-show-container">
                <i><b>Private league</b> (created by: <u>{{ league.owner.email }}</u>{% if league.contributors | length > 0 %}; contributors: <u>{{ league.contributors|map(attribute='email')|join('</u>, <u>') }}</u>{% endif %})</i>
            </div>
            {% if league.can_edit(user.email) %}
            &nbsp;&nbsp;<button id="add-contributor" class="small-button" onclick="return addContributor()">Add&nbsp;contributor&nbsp;+</button>
            <div class="contributor-edit-container">
                <input type="text" id="new_contributor_email" name="new_contributor_email" class="contributor-input" value="">
                <button class="small-button" onclick="return saveContributor()">Save&nbsp;💾</button>
                <button class="small-button" onclick="return cancelAddContributor()">Cancel&nbsp;❌</button>
            </div>
            <input type="hidden" id="update_contributors" name="update_contributors" value="">
            <input type="hidden" id="all_contributor_emails" value="{{ league.owner.email }}{% if league.contributors | length > 0 %},{{ league.contributors|map(attribute='email')|join(',') }}{% endif %}">
            {% endif %}
        </div>
        {% else %}
        <div class="contributor-container">
            <div class="contributor-show-container">
                <p><i><b>Public league</b> (anyone with the link can view and edit)</i></p>
            </div>
        </div>
        {% endif %}
        <div class="link-container">
            <div class="link-show-container">
                <b>Link:</b> <a href="http://{{ domain_name }}/league/{% if league.short_link %}{{ league.short_link }}{% else %}{{ league.id }}{% endif %}">https://{{ domain_name }}/league/{% if league.short_link %}{{ league.short_link }}{% else %}{{ league.id }}{% endif %}</a>
            </div>
            <div class="link-edit-container">
                <b>Link:</b> http://{{ domain_name }}/league/<input type="text" id="new_league_id" name="new_league_id" class="link-input" value="{% if league.short_link %}{{ league.short_link }}{% else %}{{ league.id }}{% endif %}">
                <input type="hidden" id="original_league_id" name="original_league_id" value="{% if league.short_link %}{{ league.short_link }}{% else %}{{ league.id }}{% endif %}">
                <input type="hidden" id="update_league_id" name="update_league_id" value="">
                <button class="small-button" onclick="return saveLink()">Save 💾</button>
                <button class="small-button" onclick="return cancelEditLink()">Cancel ❌</button>
            </div>
            &nbsp;&nbsp;
            <button id="copy-link" class="small-button" onclick="return copyLink('http://{{ domain_name }}/league/{% if league.short_link %}{{ league.short_link }}{% else %}{{ league.id }}{% endif %}');">Copy&nbsp;link</button>
            {% if league.can_edit(user.email) %}
                <button id="edit-link" class="small-button" onclick="return editLink();">Edit&nbsp;link&nbsp;✎</button>
            {% endif %}
        </div>
        <div style="width: 100%; overflow-x: auto;">
            <table class="league-table">
                <thead>
                    <tr>
                        <th style="width: 20%; white-space: nowrap;" rowspan="2">
                            Rounds{% if league.can_edit(user.email) %}&nbsp;&nbsp;<button id="edit-players" class="small-button" onclick="return editPlayers();">Edit&nbsp;players&nbsp;✎</button><br>{% endif %}
                            <button id="text-size-increase" class="small-button" onclick="return increaseTextSize()">🔍&nbsp;+</button>&nbsp;
                            <button id="text-size-decrease" class="small-button" onclick="return decreaseTextSize()">🔍&nbsp;-</button>&nbsp;
                            <button id="edit-save-players" class="small-button" onclick="return savePlayers()">Save&nbsp;💾</button>&nbsp;&nbsp;<button id="edit-cancel-players" class="small-button" onclick="return cancelEditPlayers()">Cancel&nbsp;❌</button>&nbsp;
                            <input type="hidden" name="update_player_names" id="update_player_names" value="">
                            
                        </th>
                        <th style="width: 80%; white-space: nowrap;" colspan="{{ league.players|length }}">Player Scores</th>
                    </tr>
                    <tr>
                        {% for player in league.players %}
                            <th class="player-scores-header" style="width: {{ width }}%; white-space: nowrap;">{{ player }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for round in league.schedule %}
                        <tr>
                            <td class="round-cell">
                                <div class="round-show-container">
                                    <div class="round-number">Round {{ round.number }}</div>
                                    {% for match in round.matches %}
                                        <div class="match">
                                            <span class="team">{{ match.players[0].name }}/{{ match.players[1].name }}</span>
                                            <span class="vs">vs</span>
                                            <span class="team">{{ match.players[2].name }}/{{ match.players[3].name }}</span>
                                        </div>
                                    {% endfor %}
                                    {% if round.players_out %}
                                        <div class="players-out">
                                            <span class="players-out-label">Out:</span> {{ round.players_out|join(', ') }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="round-edit-container">
                                    <div class="round-number">Round {{ round.number }}</div>
                                    <input type="hidden" name="round-number{{ round.number }}-matches" value="{{ round.matches|length }}">
                                    {% for match in round.matches %}
                                        <div class="match">
                                            <span class="team"><input class="team-input" type="text" name="player-name-round{{ round.number }}-match{{ loop.index }}-player1" value="{{ match.players[0].name }}">/<input class="team-input" type="text" name="player-name-round{{ round.number }}-match{{ loop.index }}-player2" value="{{ match.players[1].name }}"></span>
                                            <span class="vs">vs</span>
                                            <span class="team"><input class="team-input" type="text" name="player-name-round{{ round.number }}-match{{ loop.index }}-player3" value="{{ match.players[2].name }}">/<input class="team-input" type="text" name="player-name-round{{ round.number }}-match{{ loop.index }}-player4" value="{{ match.players[3].name }}"></span>
                                            <input type="hidden" name="original-player-name-round{{ round.number }}-match{{ loop.index }}-player1" value="{{ match.players[0].name }}">
                                            <input type="hidden" name="original-player-name-round{{ round.number }}-match{{ loop.index }}-player2" value="{{ match.players[1].name }}">
                                            <input type="hidden" name="original-player-name-round{{ round.number }}-match{{ loop.index }}-player3" value="{{ match.players[2].name }}">
                                            <input type="hidden" name="original-player-name-round{{ round.number }}-match{{ loop.index }}-player4" value="{{ match.players[3].name }}">
                                        </div>
                                    {% endfor %}
                                    {% if round.players_out %}
                                        <div class="players-out">
                                            <span class="players-out-label">Out:</span> <input class="players-out-input" type="text" name="players-out-round{{ round.number }}" value="{{ round.players_out|join(', ') }}">
                                            <input type="hidden" name="original-players-out-round{{ round.number }}" value="{{ round.players_out|join(', ') }}">
                                        </div>
                                    {% endif %}
                                </div>
                            </td>
                            {% for player in league.players %}                        
                                {% set ns1 = namespace(color="") %}
                                {% set ns2 = namespace(w="") %}
                                {% set ns3 = namespace(l="") %}
                                {% set ns4 = namespace(score="") %}
                                {% for match in round.matches %}
                                    {% if player.name in [match.players[0].name, match.players[1].name] %}
                                        {% set ns4.score = match.score[0] %}
                                        {% if match.get_winner_team() == 1 %}
                                            {% set ns1.color = "#90EE90" %}
                                            {% set ns2.w = "selected" %}
                                        {% elif match.get_winner_team() == 2 %}
                                            {% set ns1.color = "#FFCCCB" %}
                                            {% set ns3.l = "selected" %}
                                        {% endif %}
                                    {% elif player.name in [match.players[2].name, match.players[3].name] %}
                                        {% set ns4.score = match.score[1] %}
                                        {% if match.get_winner_team() == 1 %}
                                            {% set ns1.color = "#FFCCCB" %}
                                            {% set ns3.l = "selected" %}
                                        {% elif match.get_winner_team() == 2 %}
                                            {% set ns1.color = "#90EE90" %}
                                            {% set ns2.w = "selected" %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if league.scoring_system.value == 'w_l' %}
                                    {% if player.name not in round.players_out|map(attribute='name')|list %}
                                        <td style="background-color: {{ ns1.color }};">    
                                            {% if league.can_edit(user.email) %}
                                                <select class="player-score-select" name="player_score_round{{ round.number }}_player{{ loop.index }}" id="player_score_round{{ round.number }}_player{{ loop.index }}">
                                                    <option value="0"></option>
                                                    <option value="w" {{ ns2.w }}>W</option>
                                                    <option value="l" {{ ns3.l }}>L</option>
                                                </select>
                                            {% else %}
                                                <span class="player-score-label">{{ ns4.score }}</span>
                                            {% endif %}
                                        </td>
                                    {% else %}
                                        <td><span class="player-score-label">x</span></td>
                                    {% endif %}
                                {% elif league.scoring_system.value == 'score' %}
                                    {% if player.name not in round.players_out|map(attribute='name')|list %}
                                        <td style="background-color: {{ ns1.color }};">
                                            {% if league.can_edit(user.email) %}
                                                <input type="number" class="player-score-input" name="player_score_round{{ round.number }}_player{{ loop.index }}" id="player_score_round{{ round.number }}_player{{ loop.index }}" min="0" max="100" step="1" value="{{ ns4.score }}">
                                            {% else %}
                                                <span class="player-score-label">{{ ns4.score }}</span>
                                            {% endif %}
                                        </td>
                                    {% else %}
                                        <td><span class="player-score-label">x</span></td>
                                    {% endif %}
                                {% else %}
                                    <td></td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div id="footer" class="footer">
            <a href="#" class="primary-button" onclick="printPage()">Print</a>
            {% if league.scoring_system.value != 'none' and league.can_edit(user.email) %}<a class="primary-button" href="#" onclick="document.getElementById('league_form').submit()">Save</a>{% endif %}
            <a class="primary-button" href="/">Home</a>
        </div>
    </div>
    </form>
    {% if league.scoring_system.value != 'none' %}
        {% include '_ranking.html' %}
    {% endif %}
</body>
</html>