<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball League App{% if league.name %} - {{ league.name }}{% endif %}</title>
    <style>
        body {
            font-family: sans-serif;
            color: #333;
            padding: 20px;
            background-color: #f9f9f9;
        }
        
        h1 {
            color: #2c3e50;
            text-align: left;
            font-size: 32px;
        }

        p {
            font-size: 12px;
        }

        .small-button {
            font-size: 12px;
            background-color: #2c3e50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }

        .small-button:hover {
            background-color: #1a2530;
        }

        .small-button:active {
            background-color: #00881e;
        }

        .link-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .link-show-container {
            font-size: 12px;
            display: block;
        }

        .link-edit-container {
            font-size: 12px;
            display: none;
        }

        .link-input {
            width: 250px;
        }
        
        .league-table {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #3498db;
        }
        
        .league-table th, .league-table td {
            padding: 5px 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .league-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            border: 1px solid #1a2530;
        }
        
        .league-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .league-table tr:hover {
            background-color: #d4e6f1;
        }
        
        .round-cell {
            text-align: left;
            background-color: #d6eaf8;
            border-right: 2px solid #3498db !important;
            padding: 5px 5px;
            line-height: 1.4;
            white-space: nowrap;
        }
        
        .round-number {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 15px;
        }
        
        .match {
            margin-bottom: 4px;
        }
        
        .team {
            display: inline-block;
            background-color: #f8f9fa;
            padding: 1px 6px;
            border-radius: 3px;
            margin: 1px;
            border: 1px solid #bdc3c7;
            font-size: 13px;
        }
        
        .vs {
            font-weight: bold;
            color: #34495e;
            font-size: 12px;
        }
        
        .players-out {
            margin-top: 5px;
            font-size: 11px;
            color: #34495e;
            font-weight: 500;
        }
        
        .players-out-label {
            font-weight: bold;
        }
        
        .footer {
            margin-top: 20px;
            text-align: center;
        }
        
        .footer a {
            display: inline-block;
            margin: 0 10px;
            padding: 8px 16px;
            background-color: #2c3e50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .footer a:hover {
            background-color: #1a2530;
        }
        
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            
            .league-table {
                box-shadow: none;
                border: 1px solid #000;
            }
            
            .league-table th, .league-table td {
                border: 1px solid #000;
            }
            
            .footer {
                display: none;
            }
            
            .league-table th {
                background-color: #d6eaf8 !important;
                color: #000 !important;
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .round-cell {
                background-color: #f2f2f2 !important;
                border-right: 2px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .team {
                border: 1px solid #000;
            }
        }
    
        {% if league.scoring_system.value != 'none' %}
            {% include 'templates/_ranking_styles.css' %}
        {% endif %}

        {% include 'templates/_auth.css' %}
    </style>
    <script>
        function printPage() {
            // Force landscape printing
            var style = document.createElement('style');
            style.type = 'text/css';
            style.media = 'print';
            style.innerHTML = '@page { size: landscape; }';
            document.head.appendChild(style);

            window.print();
        }
        
        // Store teammate relationships for each player in each round
        const teammateMap = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            initTeammateMap();
            addScoreEventListeners();
        });
        
        var initTeammateMap = function() {
            // Create a mapping of player names to their indices
            const playerIndices = {};
            {% for player in league.players %}
                playerIndices["{{ player }}"] = {{ loop.index }};
            {% endfor %}
            
            // Create a mapping of teammates for each round
            {% for round in league.schedule %}
                teammateMap["{{ round.number }}"] = {};
                {% for match in round.matches %}
                    // Team 1
                    teammateMap["{{ round.number }}"]["{{ match.players[0].name }}"] = {
                        teammate: "{{ match.players[1].name }}",
                        teammateIndex: playerIndices["{{ match.players[1].name }}"]
                    };
                    teammateMap["{{ round.number }}"]["{{ match.players[1].name }}"] = {
                        teammate: "{{ match.players[0].name }}",
                        teammateIndex: playerIndices["{{ match.players[0].name }}"]
                    };
                    
                    // Team 2
                    teammateMap["{{ round.number }}"]["{{ match.players[2].name }}"] = {
                        teammate: "{{ match.players[3].name }}",
                        teammateIndex: playerIndices["{{ match.players[3].name }}"]
                    };
                    teammateMap["{{ round.number }}"]["{{ match.players[3].name }}"] = {
                        teammate: "{{ match.players[2].name }}",
                        teammateIndex: playerIndices["{{ match.players[2].name }}"]
                    };
                {% endfor %}
            {% endfor %}
        }
        
        var addScoreEventListeners = function() {
            // Add event listeners to all score inputs and selects
            {% for round in league.schedule %}
                {% for player in league.players %}
                    {% if player.name not in round.players_out|map(attribute='name')|list %}
                        const inputId{{ round.number }}_{{ loop.index }} = "player_score_round{{ round.number }}_player{{ loop.index }}";
                        const inputElement{{ round.number }}_{{ loop.index }} = document.getElementById(inputId{{ round.number }}_{{ loop.index }});
                        if (inputElement{{ round.number }}_{{ loop.index }}) {
                            // For number inputs (score system)
                            if (inputElement{{ round.number }}_{{ loop.index }}.type === 'number') {
                                inputElement{{ round.number }}_{{ loop.index }}.addEventListener('input', function() {
                                    syncTeammateScore("{{ round.number }}", "{{ player }}", this.value);
                                });
                            }
                            // For select elements (w/l system)
                            else if (inputElement{{ round.number }}_{{ loop.index }}.tagName === 'SELECT') {
                                inputElement{{ round.number }}_{{ loop.index }}.addEventListener('change', function() {
                                    syncTeammateScore("{{ round.number }}", "{{ player }}", this.value);
                                });
                            }
                        }
                    {% endif %}
                {% endfor %}
            {% endfor %}
        }
        
        var syncTeammateScore = function(roundNumber, playerName, value) {
            // Check if this player has a teammate in this round
            if (teammateMap[roundNumber] && teammateMap[roundNumber][playerName]) {
                const teammateInfo = teammateMap[roundNumber][playerName];
                const teammateInputId = `player_score_round${roundNumber}_player${teammateInfo.teammateIndex}`;
                const teammateInput = document.getElementById(teammateInputId);
                
                if (teammateInput) {
                    // Update the teammate's input with the same value
                    teammateInput.value = value;
                    
                    // If it's a select element, need to trigger change event for any dependent logic
                    if (teammateInput.tagName === 'SELECT') {
                        const event = new Event('change', { bubbles: true });
                        teammateInput.dispatchEvent(event);
                    }
                }
            }
        }

        var copyLink = function(link) {
            navigator.clipboard.writeText(link);
            return false;
        }

        var editLink = function() {
            document.getElementsByClassName("link-show-container")[0].style.display = "none";
            document.getElementsByClassName("link-edit-container")[0].style.display = "block";
            document.getElementById("new_league_id").focus();
            return false;
        }

        var saveLink = function() {
            if ((document.getElementById("new_league_id").value != document.getElementById("original_league_id").value) &&
                    (document.getElementById("new_league_id").value.length > 0))  
                {
                var new_league_id = document.getElementById("new_league_id").value;
                // Replace spaces and underscores with dashes
                new_league_id = new_league_id.replace(/[\s_]/g, '-');
                // Replace multiple dashes with a single dash
                new_league_id = new_league_id.replace(/-+/g, '-');
                // Replace dashes at the beginning and end with an empty string
                new_league_id = new_league_id.replace(/^-+|-+$/g, '');
                // Replace any non-alphanumeric characters (besides dashes) with an empty string
                new_league_id = new_league_id.replace(/[^a-zA-Z0-9-]/g, '');
                document.getElementById("new_league_id").value = new_league_id;
                document.getElementById("update_league_id").value = "1";
                document.getElementById("league_form").submit();
                return true;
            }
            document.getElementsByClassName("link-edit-container")[0].style.display = "none";
            document.getElementsByClassName("link-show-container")[0].style.display = "block";
            return false;
        }

        {% include 'templates/_auth.js' %}
    </script>
</head>
<body>
    {% include 'templates/_auth.html' %}
    <form id="league_form" name="league_form" action="/save_league" method="post">
    <input type="hidden" name="league_id" value="{{ league.id }}">
    <div class="container">
        {% if league.name %}
            <h1>{{ league.name }} (created on {{ league.date_created }})</h1>
        {% else %}
            <h1>League created on {{ league.date_created }}</h1>
        {% endif %}
        {% if league.owner %}
            <p><b>Created by:</b> {{ league.owner.email }}</p>
        {% endif %}
        <p>
            <div class="link-container">
                <b>Link:</b> 
                <div class="link-show-container"><a href="https://{{ domain_name }}/league/{{ league.id }}">https://{{ domain_name }}/league/{{ league.id }}</a></div>
                <div class="link-edit-container">https://{{ domain_name }}/league/<input type="text" id="new_league_id" name="new_league_id" class="link-input" value="{{ league.id }}"><input type="hidden" id="original_league_id" name="original_league_id" value="{{ league.id }}"><input type="hidden" id="update_league_id" name="update_league_id" value=""> <button class="small-button" onclick="return saveLink()">Save 💾</button></div>
                &nbsp;&nbsp;
                <button id="copy-link" class="small-button" onclick="return copyLink('https://{{ domain_name }}/league/{{ league.id }}');">Copy 🔗</button>
                <button id="edit-link" class="small-button" onclick="return editLink();">Edit ✎ᝰ</button>
            </div>
        </p>
        <table class="league-table">
            <thead>
                <tr>
                    <th style="width: 20%; white-space: nowrap;" rowspan="2">Rounds</th>
                    <th style="width: 80%; white-space: nowrap;" colspan="{{ league.players|length }}">Player Scores</th>
                </tr>
                <tr>
                    {% for player in league.players %}
                        <th style="width: {{ width }}%; white-space: nowrap;">{{ player }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for round in league.schedule %}
                    <tr>
                        <td class="round-cell">
                            <div class="round-number">Round {{ round.number }}</div>
                            {% for match in round.matches %}
                                <div class="match">
                                    <span class="team">{{ match.players[0].name }}/{{ match.players[1].name }}</span>
                                    <span class="vs">vs</span>
                                    <span class="team">{{ match.players[2].name }}/{{ match.players[3].name }}</span>
                                </div>
                            {% endfor %}
                            {% if round.players_out %}
                                <div class="players-out">
                                    <span class="players-out-label">Out:</span> {{ round.players_out|join(', ') }}
                                </div>
                            {% endif %}
                        </td>
                        {% for player in league.players %}                        
                            {% set ns1 = namespace(color="") %}
                            {% set ns2 = namespace(w="") %}
                            {% set ns3 = namespace(l="") %}
                            {% set ns4 = namespace(score="") %}
                            {% for match in round.matches %}
                                {% if player.name in [match.players[0].name, match.players[1].name] %}
                                    {% set ns4.score = match.score[0] %}
                                    {% if match.get_winner_team() == 1 %}
                                        {% set ns1.color = "#90EE90" %}
                                        {% set ns2.w = "selected" %}
                                    {% elif match.get_winner_team() == 2 %}
                                        {% set ns1.color = "#FFCCCB" %}
                                        {% set ns3.l = "selected" %}
                                    {% endif %}
                                {% elif player.name in [match.players[2].name, match.players[3].name] %}
                                    {% set ns4.score = match.score[1] %}
                                    {% if match.get_winner_team() == 1 %}
                                        {% set ns1.color = "#FFCCCB" %}
                                        {% set ns3.l = "selected" %}
                                    {% elif match.get_winner_team() == 2 %}
                                        {% set ns1.color = "#90EE90" %}
                                        {% set ns2.w = "selected" %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if league.scoring_system.value == 'w_l' %}
                                {% if player.name not in round.players_out|map(attribute='name')|list %}
                                    <td style="background-color: {{ ns1.color }};">    
                                        <select name="player_score_round{{ round.number }}_player{{ loop.index }}" id="player_score_round{{ round.number }}_player{{ loop.index }}">
                                            <option value="0"></option>
                                            <option value="w" {{ ns2.w }}>W</option>
                                            <option value="l" {{ ns3.l }}>L</option>
                                        </select>
                                    </td>
                                {% else %}
                                    <td>x</td>
                                {% endif %}
                            {% elif league.scoring_system.value == 'score' %}
                                {% if player.name not in round.players_out|map(attribute='name')|list %}
                                    <td style="background-color: {{ ns1.color }};">
                                        <input type="number" name="player_score_round{{ round.number }}_player{{ loop.index }}" id="player_score_round{{ round.number }}_player{{ loop.index }}" min="0" max="100" step="1" value="{{ ns4.score }}">
                                    </td>
                                {% else %}
                                    <td>x</td>
                                {% endif %}
                            {% else %}
                                <td></td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div id="footer" class="footer">
            <a href="#" onclick="printPage()">Print</a>
            {% if league.scoring_system.value != 'none' %}<a href="#" onclick="document.getElementById('league_form').submit()">Save</a>{% endif %}
            <a href="/">Home</a>
        </div>
    </div>
    </form>
    {% if league.scoring_system.value != 'none' %}
        {% include 'templates/_ranking.html' %}
    {% endif %}
</body>
</html>